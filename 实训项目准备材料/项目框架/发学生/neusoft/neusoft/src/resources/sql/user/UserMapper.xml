<?xml version="1.0" encoding="UTF-8" ?> 
 <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
 <mapper namespace="com.neusoft.basis.user.mapper.UserMapper"> 

	 <resultMap type="com.neusoft.basis.user.entity.UserEntity" id="userResultMap"> 
	    <id property="id" column="id" javaType="java.lang.String"/> 
	    <result property="name" column="name" javaType="java.lang.String"/> 
	    <result property="realName" column="realName" javaType="java.lang.String"/>
	    <result property="md5Password" column="password" javaType="java.lang.String"/> 
	    <result property="telephone" column="telephone" javaType="java.lang.String"/> 
	    <result property="branchId" column="branch_Id" javaType="java.lang.String"/> 
	    <result property="groupId" column="group_Id" javaType="java.lang.Integer"/> 
	    <result property="branchName" column="branch_name" javaType="java.lang.String"/> 
	    <result property="groupName" column="group_name" javaType="java.lang.String"/> 
	    <result property="isDel" column="is_del" javaType="java.lang.String"/> 
	    <result property="insertUserId" column="insert_user_id" javaType="java.lang.String"/> 
	    <result property="insertDate" column="insert_date" javaType="java.util.Date"/> 
	    <result property="lastModifyUserId" column="last_modify_user_id" javaType="java.lang.String"/> 
	    <result property="lastModifyDate" column="last_modify_date" javaType="java.util.Date"/>
	 </resultMap> 
	 
	 <resultMap type="com.neusoft.basis.user.entity.MenuItemEntity" id="menuItemResultMap"> 
	    <result property="menuId" column="menu_id" javaType="java.lang.String"/> 
	    <result property="menuName" column="menu_name" javaType="java.lang.String"/> 
	    <result property="itemId" column="item_id" javaType="java.lang.String"/> 
	    <result property="itemName" column="item_name" javaType="java.lang.String"/> 
	    <result property="itemUrl" column="item_url" javaType="java.lang.String"/> 
	    <result property="bean" column="bean" javaType="java.lang.String"/> 
	 </resultMap> 
	 
	  <!-- 查询用户名和用户密码获得用户 --> 
	<select id="getUser" parameterType="com.neusoft.basis.user.entity.UserEntity" resultMap="userResultMap"> 
	   <![CDATA[ 
	     SELECT * from user u 
	     WHERE u.id = #{id}
	       AND u.password = #{md5Password}
	       AND u.is_del = 0
	    ]]> 
    </select> 
    
    <select id="getUserMenuItem" parameterType="java.lang.Integer" resultType="com.neusoft.basis.user.entity.MenuItemEntity" resultMap="menuItemResultMap">
       SELECT t.menu_id,t.menu_name,t.item_id,t.item_name,t.item_url
		from(
		SELECT m.id menu_id,m.`name` menu_name,m.order_num menu_order_num,i.id item_id,i.`name` item_name,i.order_num item_order_num,i.url item_url
		  from `group` g,group_item_rel gir,item i,menu_item_rel mir,menu m
		  where g.id = #{groupId}
		    and g.is_del = '0'
		    and g.id = gir.group_id
		    and gir.item_id = i.id
		    and i.is_del = '0'
		    and i.id = mir.item_id
		    and mir.menu_id = m.id
		    and m.is_del = '0'
		    and i.type = '1'
		    order by m.order_num,i.order_num) t   
    </select>
    
    <select id="getUserScoreMenuItem" parameterType="java.lang.Integer" resultType="com.neusoft.basis.user.entity.MenuItemEntity" resultMap="menuItemResultMap">
       SELECT t.menu_id,t.menu_name,t.item_id,t.item_name,t.item_url,t.bean
		from(
		SELECT m.id menu_id,m.`name` menu_name,m.order_num menu_order_num,i.id item_id,i.`name` item_name,i.order_num item_order_num,i.url item_url,i.bean
		  from `group` g,group_item_rel gir,item i,menu_item_rel mir,menu m
		  where g.id = #{groupId}
		    and g.is_del = '0'
		    and g.id = gir.group_id
		    and gir.item_id = i.id
		    and i.is_del = '0'
		    and i.id = mir.item_id
		    and mir.menu_id = m.id
		    and m.is_del = '0'
		    and i.type = '2'
		    order by m.order_num,i.order_num) t   
    </select>
    
    <insert id="insertUser" parameterType="com.neusoft.basis.user.entity.UserEntity"> 
	    insert into user(id,name,realName,telephone,password,branch_Id,group_Id,is_del,insert_user_id,insert_date)
	           values(#{id}, #{name},#{realName},#{telephone},#{md5Password},#{branchId},#{groupId},'0',#{insertUserId},#{insertDate})
	</insert> 
    
    <select id="getAllUser" resultMap="userResultMap">
       SELECT u.*,b.name branch_name,g.name group_name from user u left join branch b on(u.branch_id = b.id
       ) ,`group` g
    where  u.group_id = g.id;
    </select>
    
    <select id="getUserBuId" parameterType="java.lang.String" resultMap="userResultMap"> 
	   <![CDATA[ 
	     SELECT * from user u
	     WHERE u.id = #{id}
	    ]]> 
    </select> 
	
	<update id="updateUser" parameterType="com.neusoft.basis.user.entity.UserEntity" > 
	    update user
	       set name= #{name},
	           realName = #{realName},
	           telephone = #{telephone},
	           branch_Id = #{branchId},
	           group_Id = #{groupId},
	           is_del = #{isDel},
	           last_modify_user_id =  #{lastModifyUserId},
	           last_modify_date =  #{lastModifyDate}
	     WHERE id = #{id}
	</update> 
	
    <update id="updateUserPassword" parameterType="com.neusoft.basis.user.entity.UserEntity" > 
	    update user
	       set password = #{md5Password},
	           last_modify_user_id =  #{lastModifyUserId} ,
	           last_modify_date =  #{lastModifyDate}       
	     WHERE id = #{id}
	</update> 
	
</mapper> 
